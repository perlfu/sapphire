#! /bin/bash
#
# (C) Copyright IBM Corp. 2003
#
# $Id$
#
# Run Jikes RVM under the gdb debugger.
#
# The script handles passing command line arguments to the Jikes RVM
# executable and executing a standard gdb macro file that does some
# common setup tasks.
#
# @author Dave Grove
# @modified Steven Augart
#    Converted to Bash.

# Sanity checks
# Where are we?
# 
mydir="${0%/*}"

## Load aux. functions
. $mydir/sanity-envars.bash


checkenv HOME
checkenv RVM_ROOT
checkenv RVM_BUILD

# TODO: This portion of the gdbrvm should be consolidated with the originally-identical part of runrvm.

. $RVM_BUILD/environment

ARGS="-X:i=$RVM_BUILD/RVM.image -X:vmClasses=$RVM_BUILD/RVM.classes/jksvm.jar:$RVM_BUILD/RVM.classes/rvmrt.jar"

for arg in "$@"; do
   if   [[ $arg = --   ]]; then
     print "$ME: the command line option \"--\" is no longer used!"
   fi
done

#
# Need to make some more defines
#
ARGS="$ARGS -Drvm.root=$RVM_ROOT"
ARGS="$ARGS -Drvm.build=$RVM_BUILD"
ARGS="$ARGS -Djava.home=$RVM_ROOT"
ARGS="$ARGS -Dgnu.classpath.home.url=file:${RVM_BUILD}"
ARGS="$ARGS -Dgnu.classpath.vm.shortname=JikesRVM"

ARGS="$ARGS -Duser.home=$HOME -Duser.dir=${PWD} -Dos.name=$(uname -s) -Dos.version=$(uname -r) -Dos.arch=$(uname -m)"

# Now execute the VM
echo set args $ARGS "$@" > $RVM_BUILD/gdb.commandlineArgs
gdb $RVM_BUILD/JikesRVM -x $RVM_BUILD/gdb.commandlineArgs -x $RVM_ROOT/rvm/bin/gdbInit
