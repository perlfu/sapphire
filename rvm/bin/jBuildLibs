#!/bin/ksh
#
# (C) Copyright IBM Corp. 2001
#
#$Id$
#
# Build the RVM standard libraries, rvmrt.jar, from the java source files.
#
# Invocation:  jBuildLibs
#
# Authors: Julian Dolby, Stephen Fink, David Grove

# Stop immediately if any programs we call return errors.
#
set -e

# Who we are.
#
ME=`basename $0`

# Place where source files reside.
#
if [[ X$RVM_ROOT = "X" ]]; then
   print "$ME: please set your RVM_ROOT environment variable (eg. $HOME/rvmRoot)"
   exit 1
fi

# Place where jalapeno bootimage, booter, and runtime support files 
# will be placed.
#
if [[ X$RVM_BUILD = "X" ]]; then
   print "$ME: please set your RVM_BUILD environment variable (eg.  $HOME/rvmBuild)"
   exit 1
fi

# What configuration will host the build process
#
if [[ $RVM_HOST_CONFIG = "" ]]; then
   print "$ME: please set your RVM_HOST_CONFIG environment variable"
   print " eg. $RVM_ROOT/rvm/config/powerpc-ibm-aix4.3.3.0"
   exit 1
fi
. $RVM_HOST_CONFIG

# Create a temporary build directory
$RVM_ROOT/rvm/bin/jconfigure -D "BUILD_RVMRT_JAR=1" BaseBasecopyingGC
cd $RVM_BUILD
./jbuild.expand
./jbuild.copy

# Copy the library sources 
cp -r $RVM_ROOT/support/lib/src/* $RVM_BUILD/Jalapeno.classes

# Compile the RVM sources
./jbuild.compile

# Compile the library sources
cd $RVM_BUILD/Jalapeno.classes
$FIND com -name CVS -prune -o -name '*.java' -print | $XARGS $RVM_BUILD/jbuild.tool
$FIND java -name CVS -prune -o -name '*.java' -print | $XARGS $RVM_BUILD/jbuild.tool

cd $RVM_BUILD/Jalapeno.classes
# Create the file rvmrt.id, containing the date
date > rvmrt.id

# Create the jar file
$FIND . -type f | $GREP -v \.class\$ | $GREP -v rvmrt.id | $XARGS rm -f
$HOST_JAR -cvf $RVM_BUILD/rvmrt.jar com java rvmrt.id

# Install the new jar file?
if tty -s; then # keyboard is live (ie. this is not an automated build)
  print -n "$ME: Install new rvmrt.jar in $RVM_ROOT/support/lib? (y/n)"
  read response
  if [[ $response = y ]]; then
    print "$ME: Copying rvmrt.jar to $RVM_ROOT/support/lib"
    cp -f $RVM_BUILD/rvmrt.jar $RVM_ROOT/support/lib
  fi
fi
