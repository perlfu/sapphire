#!/usr/bin/perl
#
# (C) Copyright IBM Corp. 2001
#
# $Id$
#
# Invoke Jikes RVM virtual machine that was created by "jcreate"
#
# @author Perry Cheng
# @date 


# Who we are.
#
$ME=`basename $0`;
$ME=~s/\n//;

# Extract the "-v config" option from arg list
while (($cur = shift @ARGV) ne "") {
  if ($cur eq "-v") { 
    $config = shift @ARGV; 
    if ($config eq "") { 
       print "Usage: $ME -v config <more VM options> class-name args ...\n";
       exit 1;
    }
    next;
  }
  push @ARGV_COPY, $cur;
}
@ARGV = @ARGV_COPY;

# Figure out the directory the image resides in; define $RVM_BUILD if necessary
#
if ($config ne "") {
   if ($ENV{RVM_IMAGES} eq "") {
     print "$ME: please set your RVM_IMAGES environment variable (eg. $RVM_ROOT/rvmImages) when using -v\n";
     exit 1;
   }
   $ENV{RVM_BUILD} = $ENV{RVM_IMAGES} . "/" . $config;
}
else {
   if ($ENV{RVM_BUILD} eq "") {
     print "$ME: please set your RVM_BUILD environment variable (eg. $HOME/rvmBuild) when not using -v\n";
     exit 1;
    }
}

if (!(-e "$ENV{RVM_BUILD}/JikesRVM")) {
  print "$ME: missing image file \"$ENV{RVM_BUILD}/JikesRVM\"\n";
  exit 1;
}

# Setup target environment variables
#
if (!(-e "$ENV{RVM_BUILD}/environment.pl")) {
  print "$ME: missing environment file \"$ENV{RVM_BUILD}/environment.pl\"\n";
  exit 1;
}

eval `cat $ENV{RVM_BUILD}/environment.pl`;

# Create additional arguments: image, class path
#
if (`uname` eq "CYGWIN_NT-5.0") {
  # need to kludge path to image because we use win32 api calls to mmap it.
  # other paths can be left in "unix" form; we use cygwin api calls for them.
  push @ARGS, "-X:i=`cygpath -p -w $ENV{RVM_BUILD}/RVM.image`";
  push @ARGS, "-X:vmClasses=`cygpath -p -w $ENV{RVM_BUILD}/RVM.classes`";
} 
else {
  push @ARGS, "-X:i=$ENV{RVM_BUILD}/RVM.image";
  if (-e "$ENV{RVM_BUILD}/javamath.jar") {
    push @ARGS, "-X:vmClasses=$ENV{RVM_BUILD}/RVM.classes/jksvm.jar:$ENV{JAL_ROOT}/support/lib/jazzlib.jar:$ENV{RVM_BUILD}/javamath.jar:$ENV{RVM_BUILD}/RVM.classes/rvmrt.jar";
  }
  else {
    push @ARGS, "-X:vmClasses=$ENV{RVM_BUILD}/RVM.classes/jksvm.jar:$ENV{JAL_ROOT}/support/lib/jazzlib.jar:$ENV{RVM_BUILD}/RVM.classes/rvmrt.jar";
  }
}

sub runCommand {
  my $arg = shift @_;
  my $result = `$arg`;
  chomp($result);
  return $result;
}

push @ARGS, "-Duser.home=$ENV{HOME}";
push @ARGS, "-Duser.dir=" . (runCommand("pwd"));
push @ARGS, "-Dos.name=" . (runCommand("uname -s"));
push @ARGS, "-Dos.version=" . (runCommand("uname -r"));
push @ARGS, "-Dos.arch=" . (runCommand("uname -m"));
$LOADPATH = "$ENV{RVM_BUILD}:$ENV{HOST_JAVA_HOME}/jre/bin:$ENV{HOST_JAVA_HOME}/jre/bin/classic";
$ENV{LIBPATH} = "$ENV{LIBPATH}:$LOADPATH";
$ENV{LD_LIBRARY_PATH} = "$ENV{LD_LIBRARY_PATH}:$LOADPATH";

# Run it!
#
# print "$ENV{RVM_BUILD}/JikesRVM", @ARGS, @ARGV;
exec "$ENV{RVM_BUILD}/JikesRVM", @ARGS, @ARGV;


