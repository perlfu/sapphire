#! /bin/bash
#
# (C) Copyright IBM Corp. 2001, 2003, 2003
#
# $Id$
#
# Invoke the rvm script using environmental variables
#
# @author Jeffrey Palm
# @date   25 Jun 2002
# @modified Steven Augart (ported to bash)
# @date May 31, 2003


# What is our name?
# Bash internal shorthand that works like the "basename" command.
ME="${0##*/}"

# Where are we?
# Bash internal shorthand that works like the "dirname" command.
mydir="${0%/*}"			# temporary; directory we were run from

function croak_nonusage () {
    # Display the error message.  If it's a multi-line error message, indent
    # the second and subsequent lines by a few spaces.  
    # Try to auto-wrap the message if we have GNU Fold.

    local gnufold="/usr/bin/fold --width=65 --spaces"
    $gnufold < /dev/null &> /dev/null || gnufold=cat

    echo "${ME}: $*" | $gnufold | sed -e '2,$s/^/     /' >&2
    trap '' EXIT
    exit 1
}


if [[ $mydir && $mydir != $ME ]]; then
    # Where to find auxiliary programs:
    bin_dir="${mydir}"
else
    bin_dir="${RVM_ROOT:?$ME: You must set the RVM_ROOT variable before you run this program.}/rvm/bin"
fi

sanity_env="${bin_dir}/sanity-envars.bash"
[[ -f $sanity_env ]] || croak_nonusage "Internal error: Cannot find the file sanity-envars.bash ($sanity_env); something is badly broken."
[[ -r $sanity_env ]] || croak_nonusage "Internal error: Cannot read the file sanity-envars.bash ($sanity_env); something is badly broken.  You might check the file permissions or user id you used to extract Jikes RVM."
. "${sanity_env}";		# Defines checkenv()

## Sanity checks for environment variables.

checkenv HOME
# Place where source files reside.
checkenv RVM_ROOT
[[ -e $RVM_ROOT ]] || croak_nonusage "The directory RVM_ROOT ($RVM_ROOT) does not exist.  Something is wrong; check your RVM_ROOT environment variable."
[[ -d $RVM_ROOT/. ]] || croak_nonusage "RVM_ROOT ($RVM_ROOT) exists, but is not a directory or a symbolic link to a directory.  Something is wrong; check your RVM_ROOT environment variable."

bin_dir="${RVM_ROOT}/rvm/bin";
[[ -d $RVM_ROOT/rvm/bin/. ]] || croak_nonusage "Can't find the directory RVM_ROOT/rvm/bin ($RVM_ROOT/rvm/bin/.).  Something is wrong; check your RVM_ROOT environment variable."
# Place where RVM bootimage, booter, and runtime support files were placed.
checkenv RVM_BUILD
[[ -e $RVM_BUILD ]] || croak_nonusage "The directory RVM_BUILD ($RVM_BUILD) does not exist.  Something is wrong; check your RVM_BUILD environment variable."
[[ -d $RVM_BUILD/. ]] || croak_nonusage "RVM_BUILD ($RVM_BUILD) exists, but is not a directory or a symbolic link to a directory.  Something is wrong; check your RVM_BUILD environment variable."

[[ -f ${bin_dir}/runrvm ]] || croak_nonusage "Can't find the program $bin_dir/runrvm.  Are you sure your RVM_ROOT variable is set correctly?"
# Pass these along as parameters to runrvm.
#. "${mydir}/runrvm" "$HOME" "$RVM_ROOT" "$RVM_BUILD" "$@"
. "${bin_dir}/runrvm" "$HOME" "$RVM_ROOT" "$RVM_BUILD" "$@"
