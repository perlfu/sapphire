The vast majority of Jikes RVM's source code is in Java ($\approx 1049$
source files as of this writing.)  This section describes a set of
coding style guidelines that we recommend for all Java code added to
Jikes\trademark RVM.

This section also includes one or more coding conventions that we
use within Jikes RVM.  

\subsection{Coding Convention}

\subsubsection{The {\tt VM\_} prefix}

By convention, any class which should be loaded into the boot image
starts its name with {\tt VM\_}.  This is used by the build configurator,
{\tt jconfigure}, which uses that information to create {\tt
\$RVM\_BUILD/RVM.primordials}, the file containing the list of classes
that should be written into \jrvm{}'s  boot image.

The JMTk (see~\ref{section:JMTk}) classes don't follow this naming convention
because they're an independent subsystem, but the rest of \jrvm{} does.

\subsubsection{Assertions}
\label{assertions}

Partly for historical reasons, we use our own built-in assertion
facility rather than the one that appeared in Sun's JDK 1.4.   All
assertion checks have one of the two forms:
\begin{example}
\tt{}    if (VM.VerifyAssertions)  VM._assert({\it condition}
\tt{}    if (VM.VerifyAssertions)  VM._assert({\it condition}, {\it message})
\end{example}
{\tt VM.VerifyAssertions} is a {\tt 
public static final} field.  The {\tt RVM\_WITHOUT\_ASSERTIONS}
configuration variable determines {\tt VM.VerifyAssertions}' value.
If {\tt RVM\_WITHOUT\_ASSERTIONS} is enabled, \jrvm{} has no assertion
overhead. 

If you use the form without a {\it message}, then the default message
``{\tt vm internal error at:}''  will appear.  

If you use the form with a {\it message} the message {\em must} be a
single string literal.  Doing string appends in assertions can be a
source of horrible performance problems when assertions are enabled
(ie most development builds).  If you want to provide a
more detailed error message when the assertion fails, then you must
use the following coding pattern:
\begin{example}
\tt{}   if (VM.VerifyAssertions && {\it condition}) VM._assert(false, {\it message});
\end{example}

An assertion failure is always followed by a stack dump.


\subsection{Coding Style Introduction}

Regrettably, much code in the current system does not follow any
consistent coding style.  This is an unfortunate residuum of the
system's evolution.  It makes editing sometimes unpleasant, and
prevents Javadoc from formatting comments in many files.  To alleviate
this problem, we present this style guide for new Java code; it's just
a small tweak of Sun's style guide.

\subsection{File Headers}

Every file needs to have a header with a copyright notice, a Javadoc
{\tt @author} tag, and an RCS/CVS {\tt \$Id\$} entry. There may be
multiple Javadoc {\tt @author} tags, and there may
additionally be a {\tt @modified} tag for someone who modified code but
doesn't want to claim co-authorship.  ({\tt @modified} is our own
extended tag.)  There is usually also a Javadoc {\tt @date} field for
the date of authorship.  An example of the notices follow.  You can
just cut-and-paste one from an existing source file.

We add the Javadoc authorship tags even to non-Java source files, such
as shell scripts and C programs.
\begin{example}
\tt{}/*
 * (C) Copyright IBM Corp 2003
 * \${}Id{}: SourceFile.java,v 1.105 2003/07/14 22:41:44 augart-oss Exp \$
 * @author Steven Augart
 * @date 10 July 2003
 */
\end{example}


\index{Coding Style}
\index{Java source code style}
\subsection {Coding style description}

The Jikes\trademark RVM coding style guidelines are defined with
reference to the Sun 
Microsystems ``Code Conventions for the Java\trademark Programming Language'',
with a few exceptions listed below.  The Sun coding
conventions can be found at 
\xlink{{\tt \SunCodeConventionURL}} {\SunCodeConventionURL} in HTML,
PostScript, and PDF.  Most of the style guide is intuitive; 
however, please read through the document (or at least look at its sample code).

We have adopted four modifications to the Sun code conventions:
\begin{enumerate}
\index{indenting}
\item {\bf Two-space indenting} The Sun coding convention suggests 4
space indenting; however with 80-column lines and four-space indenting,
there is very little room left for code.  Thus, we recommend using 2
space indenting.

\item {\bf 132 column lines in exceptional cases} The Sun coding convention is
that lines be no longer than 80 columns.  Several Jikes RVM
contributors have found this constraining.  Therefore, we allow 132
column lines for exceptional cases, such as to avoid bad line breaks.

\item {\bf \tt if (VM.VerifyAssertions)}
As a special case, the condition {\tt if (VM.VerifyAssertions)} is
usually immediately followed by the call to {\tt VM.\_assert()},
with a single space substituting for the normal
newline-and-indentation.  There's an example in \ref{assertions}.    

\item {\bf Capitalized fields} 
Under the Sun coding conventions, and as specified in 
{\em The Java Language Specification, Second Edition}, the names of
fields begin with a lowercase letter.  (The only exception they give
is for some {\tt final static} constants, which have names
ALL\_IN\_CAPITAL\_LETTERS, with underscores separating them.)  That
convention reserves
IdentifiersBeginningWithACapitalLetterFollowedByMixedCase for the
names of classes and interfaces.  However, most of the {\tt final}
fields in the {\tt VM\_Configuration} class and the {\tt VM\_Properties}
interface also are in that format.   

Since the {\tt VM} class inherits
fields from both {\tt VM\_Properties} and {\tt VM\_Configuration},
that's how we get {\tt VM.VerifyAssertions}, etc.
%
% If you run: find ${RVM_ROOT}/rvm -name \*.java -print0 | xargs -0 -e egrep -n -e '[^\.]\.[A-Z]+[_a-z0-9][_A-Za-z0-9]+\>[	 ]*=[^=]'  | grep -v sysWrite | egrep -v -e '^[[:space:]]*\*'
% you'll discover 58 lines in the source tree where we also have
% variables that don't meet the specification.  Bummer.

\end{enumerate}

\JikesTMFooter

\JavaTMFooter

\subsection {Javadoc requirements}
\index{Javadoc}

All files should contain descriptive comments
in Javadoc form (
\xlink{{\tt \JavadocURL}} {\JavadocURL}
) so
that documentation can be generated automatically.  Of course,
additional non-Javadoc source code comments should appear as
appropriate.
For Javadoc, at a minimum,

\begin{enumerate}
\item All classes and methods should have a block comment describing
them
\item All methods contain a short description of their arguments
(using {\tt @param}), the return value (using {\tt @return}) and the
exceptions they may throw (using {\tt @throws}).
\item Each class should include {\tt @see} and {\tt @link} 
references as appropriate.
\end{enumerate}

\subsection {Useful tools/hints}
\index{editing source code}
\index{vi}
\index{emacs}

This section describes helpful hints for conforming with the style
guide.  Below are suggestions on how to setup the two most common
editors, emacs and vi. 
%\remark{If we find a pretty-print code processor, we
%can describe it in this section.}

\subsubsection{emacs} 

The following tells {\tt emacs} to indent 2 spaces:
\begin{verbatim}
;; You have to do it in this complicated way because of the
;; strange way the cc-mode initializes the value of `c-basic-offset'.
(add-hook 'c-mode-hook (lambda () (setq c-basic-offset 2)))
(add-hook 'java-mode-hook (lambda () (setq c-basic-offset 2)))
\end{verbatim}
If you want {\tt emacs} to truncate long lines instead of wrapping them, add
the following to your c/java mode hook:
\begin{verbatim}
(setq truncate-lines 't)
\end{verbatim}

\subsubsection{vi}\label{options:vi/vim}

If you are more comfortable with {\tt vi}, it is recommended that you
use a {\tt vi} clone called {\tt vim} 
(\xlink{{\tt \VimURL}}{\VimURL}).  It
contains all of {\tt vi}'s commands and is fully backward compatible,
but is much more configurable than {\tt vi}.  Hints for {\tt vi}
diehards who absolutely refuse to use {\tt vim} are provided at the end
of this subsection (\ref{options:vi}).

\paragraph{vim}\label{options:vim}

If you are using vim version 6.0 or higher, then you can add the
following to your {\tt .vimrc} for formatting:

\T {\small
\begin{verbatim}
set shiftwidth=2           " for indenting and shifting
set expandtab              " to replace tab characters by spaces
set smarttab               " to allow the use of <Tab> for indenting
set formatoptions-=t2croq  " reset formatting
set formatoptions+=croq    " format comments
set textwidth=0            " don't wrap text
set wrapmargin=0           " ditto
" Java mode setup
augroup java
   autocmd!
   autocmd BufEnter *.java set cindent
   autocmd BufEnter *.java set cinoptions=>s,e0,n0,f0,{0,}0,^0,:s,=s,ps,ts,c3,+s,(0,u0,)20,*30,gs,hs
   autocmd BufEnter *.java set cinwords=if,else,while,do,for,switch,static,new
   autocmd BufLeave *.java set nocindent
augroup END
\end{verbatim}
If you want {\tt vim} to truncate long lines instead of wrapping them, add
the following to your {\tt .vimrc}:
\begin{verbatim}
set formatoptions+=t " to allow autowrap text
set textwidth=74    " to allow autowrap text at 74th column
\end{verbatim}
\T }

\paragraph{vi}\label{options:vi}

Standard {\tt vi} options that would approximate Java\trademark formatting are:
\begin{verbatim}
set shiftwidth=2  " for indenting and shifting
set autoindent    " automatically indent new lines to the start of previous
\end{verbatim}
and the approximation for wrapping long lines is
\begin{verbatim}
set wrapmargin=6  " to allow autowrap text at 74th column
\end{verbatim}

\JavaTMFooter

% LocalWords:  Javadoc param

