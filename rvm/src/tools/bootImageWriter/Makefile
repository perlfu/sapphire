#
# (C) Copyright IBM Corp. 2001
#
#$Id$
# @author Derek Lieber

include		$(RVM_ROOT)/rvm/build.Make.rules

HOST_JDK_FLAGS=
HOST_MEM_MAX=325M
HOST_MEM_MIN=325M

JCOMPILE=$(HOST_JIKES) +F +Z +KINSTRUCTION=$(TARGET_INSTRUCTION_TYPE) +E -g +U -classpath $(JAL_BUILD)/RVM.classes:$(JAL_BUILD)/RVM.classes/rvmrt.jar

$SRCS=	BootImage.java \
	BootImageChecker.java \
	BootImageMap.java \
	BootImageWriter.java \
	BootImageWriterConstants.java \
	BootImageWriterMessages.java

# The following will set the build time alloc advice flag appropriately
# if the GCTk_ALLOC_ADVICE_FILE environment variable is set.
ifdef GCTk_ALLOC_ADVICE_FILE
ALLOC_ADVICE_INFO=-X:bc:alloc_advice_file=$(GCTk_ALLOC_ADVICE_FILE)
else
ALLOC_ADVICE_INFO=
endif

ZIP_KLUDGE_CLASSES = java/util/zip/ZipConstants.class
MAP_KLUDGE_CLASSES = java/util/HashMap* java/util/HashSet* java/util/Map*
UTIL_KLUDGE_CLASSES = $(ZIP_KLUDGE_CLASSES) $(MAP_KLUDGE_CLASSES)
UTIL_KLUDGE_EXTRACT = $(foreach PAT, $(UTIL_KLUDGE_CLASSES), '$(PAT)')
UTIL_KLUDGE_JAR=$(SCRATCH_DIR)/libyuck.jar

$(UTIL_KLUDGE_JAR):		$(JAL_ROOT)/support/lib/rvmrt.jar
	cd $(SCRATCH_DIR); unzip -Uoqq $< $(UTIL_KLUDGE_EXTRACT) > /dev/null 2> /dev/null
	cd $(SCRATCH_DIR); $(HOST_JAR) cvf `$(HOST_JAVA_PATH_ADJUST) $@` $(UTIL_KLUDGE_CLASSES) > /dev/null 2> /dev/null
	@print -n "(built workaround zip) "

#
# The -Xbootclasspath/p:$(UTIL_KLUDGE_JAR) is a kludge to force
# the hosting jvm to use the same java.util files that the rvm will use
# at run time.  This mechanism is very fragile and only works for a 
# subset of java.util classes (discovered by trial and error).  
#

# Create a boot image.
# Parameters from 'make' command line are:
#   RVM_INSTRUCTION_TYPE = datatype used for representing machine instructions
#   RVM_BOOTIMAGE = place to put boot image
#   RVM_REPOSITORIES = path to search for classes
#   RVM_BOOTIMAGE_CLASSES = place to read names of classes to be put in boot image
#   RVM_BOOTIMAGE_COMPILER_ARGS = command line arguments to pass to boot image compiler
#   RVM_BOOTIMAGE_WRITER_ARGS = command line arguments to pass to boot image writer
#   VERBOSE_ARG = command-line argument for verbose host jdk options
$(RVM_BOOTIMAGE): $(SCRATCH_DIR)/BootImageWriter.class $(UTIL_KLUDGE_JAR)
	$(HOST_JAVA) -Xbootclasspath/p:`$(HOST_JAVA_PATH_ADJUST) $(UTIL_KLUDGE_JAR)` \
	   -Xms$(HOST_MEM_MIN) -Xmx$(HOST_MEM_MAX)\
	   -classpath `$(HOST_JAVA_PATH_ADJUST) \
			$(SCRATCH_DIR):$(RVM_REPOSITORIES)` \
	   -Djava.security.policy=rvm.security \
	   $(HOST_JDK_FLAGS) $(VERBOSE_ARG) \
	   BootImageWriter\
	   -classpath `$(HOST_JAVA_PATH_ADJUST) $(RVM_REPOSITORIES)`\
	   -n `$(HOST_JAVA_PATH_ADJUST) $(RVM_BOOTIMAGE_CLASSES)`\
	   -o `$(HOST_JAVA_PATH_ADJUST) $(RVM_BOOTIMAGE)`\
	   $(ALLOC_ADVICE_INFO)\
	   $(RVM_BOOTIMAGE_COMPILER_ARGS) \
	   $(RVM_BOOTIMAGE_WRITER_ARGS) \
	   $(IMAGE_ADDRESS_ARG)
	@print -n "(bootimage linked) "

$(SCRATCH_DIR)/BootImageWriter.class:	$(SRCS)
	@$(JCOMPILE) -d $(SCRATCH_DIR) BootImageWriter.java

